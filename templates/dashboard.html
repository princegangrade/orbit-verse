{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-12"
    x-data="{
        activeMode: null,
        terminalLines: ['Initializing system...', 'Loading user profile...', 'Connecting to Orbit Verse core...'],
        treePrompt: '',
        treeLoading: false,
        treeError: '',
        treeData: null,
        async generateTree() {
            this.treeError = '';
            if (!this.treePrompt || this.treePrompt.trim().length < 5) {
                this.treeError = 'Please enter a brief project description.';
                return;
            }
            this.treeLoading = true;
            try {
                const res = await fetch('/api/ai/project-tree/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ prompt: this.treePrompt })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Unable to generate tree.');
                this.treeData = data;
                this.$nextTick(() => { if (window.lucide) window.lucide.createIcons(); });
            } catch (e) {
                this.treeError = e.message;
            } finally {
                this.treeLoading = false;
            }
        }
    }"
    x-init="setTimeout(() => terminalLines.push('System Ready.'), 1500)">

    <!-- Welcome Header -->
    <div class="flex items-center justify-between animate-fade-in">
        <div>
            <h1 class="text-4xl font-bold text-white tracking-tight">Mission Control</h1>
            <p class="text-slate-400 mt-2 text-lg">Select your deployment vector, Commander {{ user.username }}.</p>
        </div>
        <div class="hidden md:flex items-center gap-3">
            <div class="px-4 py-2 rounded-full glass flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-mono text-green-400">SYSTEM ONLINE</span>
            </div>
        </div>
    </div>

    <!-- Mode Selection (Collapsible Cards) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Full Auto Mode -->
        <div @click="activeMode = activeMode === 'full' ? null : 'full'"
            class="relative group cursor-pointer transition-all duration-500 ease-out"
            :class="activeMode === 'full' ? 'md:col-span-3 bg-blue-900/20' : 'glass hover:bg-slate-800/50'">

            <div
                class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-xl border border-blue-500/50">
            </div>

            <div class="relative p-6 h-full flex flex-col justify-between overflow-hidden rounded-xl border border-white/5"
                :class="{'border-blue-500 box-shadow-glow': activeMode === 'full'}">

                <div class="flex items-start justify-between">
                    <div class="p-3 bg-blue-500/20 rounded-lg text-blue-400">
                        <i data-lucide="zap" class="w-8 h-8"></i>
                    </div>
                    <div class="text-right">
                        <h3 class="text-xl font-bold text-white group-hover:text-blue-400 transition-colors">Full Auto
                        </h3>
                        <p class="text-xs text-slate-500 uppercase tracking-wider mt-1">AI Autonomous</p>
                    </div>
                </div>

                <div class="mt-4">
                    <p class="text-slate-400 text-sm leading-relaxed" :class="{'hidden': activeMode === 'full'}">
                        End-to-end generation from a single prompt. AI handles architecture, code, and deployment.
                    </p>

                    <!-- Expanded Content -->
                    <div x-show="activeMode === 'full'" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-4"
                        x-transition:enter-end="opacity-100 translate-y-0" class="mt-6 border-t border-white/10 pt-6">
                        <p class="text-slate-300 mb-6 max-w-2xl">
                            Describe your vision, and Orbit Verse will generate a complete production-ready application.
                            Includes database schema, backend API, frontend UI, and Docker configuration.
                        </p>
                        <a href="{% url 'prompt' %}"
                            class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-blue-900/50 transition-all hover:scale-105">
                            <i data-lucide="rocket" class="w-5 h-5"></i>
                            Initiate Launch Sequence
                        </a>
                    </div>
                </div>

                <div class="absolute bottom-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="cpu" class="w-24 h-24 text-blue-500"></i>
                </div>
            </div>
        </div>

        <!-- Semi Auto Mode -->
        <div @click="activeMode = activeMode === 'semi' ? null : 'semi'"
            class="relative group cursor-pointer transition-all duration-500 ease-out"
            :class="activeMode === 'semi' ? 'md:col-span-3 bg-purple-900/20' : 'glass hover:bg-slate-800/50'">

            <div
                class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-xl border border-purple-500/50">
            </div>

            <div class="relative p-6 h-full flex flex-col justify-between overflow-hidden rounded-xl border border-white/5"
                :class="{'border-purple-500 box-shadow-glow': activeMode === 'semi'}">
                <div class="flex items-start justify-between">
                    <div class="p-3 bg-purple-500/20 rounded-lg text-purple-400">
                        <i data-lucide="activity" class="w-8 h-8"></i>
                    </div>
                    <div class="text-right">
                        <h3 class="text-xl font-bold text-white group-hover:text-purple-400 transition-colors">Semi Auto
                        </h3>
                        <p class="text-xs text-slate-500 uppercase tracking-wider mt-1">Collaborative</p>
                    </div>
                </div>

                <div class="mt-4">
                    <p class="text-slate-400 text-sm leading-relaxed" :class="{'hidden': activeMode === 'semi'}">
                        Iterative development with AI checkpoints. Review designs before implementation.
                    </p>

                    <!-- Expanded Content -->
                    <div x-show="activeMode === 'semi'" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-4"
                        x-transition:enter-end="opacity-100 translate-y-0" class="mt-6 border-t border-white/10 pt-6">
                        <p class="text-slate-300 mb-6 max-w-2xl">
                            Work alongside the AI. Approve specific architectural decisions, database models, and UI
                            components step-by-step.
                        </p>
                        <a href="{% url 'create_semi_auto' %}"
                            class="inline-flex items-center gap-2 bg-purple-600 hover:bg-purple-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-purple-900/50 transition-all hover:scale-105">
                            <i data-lucide="git-branch" class="w-5 h-5"></i>
                            Start Collaborative Session
                        </a>
                    </div>
                </div>

                <div class="absolute bottom-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="share-2" class="w-24 h-24 text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Manual Mode -->
        <div @click="activeMode = activeMode === 'manual' ? null : 'manual'"
            class="relative group cursor-pointer transition-all duration-500 ease-out"
            :class="activeMode === 'manual' ? 'md:col-span-3 bg-amber-900/20' : 'glass hover:bg-slate-800/50'">

            <div
                class="absolute inset-0 bg-gradient-to-br from-amber-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-xl border border-amber-500/50">
            </div>

            <div class="relative p-6 h-full flex flex-col justify-between overflow-hidden rounded-xl border border-white/5"
                :class="{'border-amber-500 box-shadow-glow': activeMode === 'manual'}">
                <div class="flex items-start justify-between">
                    <div class="p-3 bg-amber-500/20 rounded-lg text-amber-400">
                        <i data-lucide="wrench" class="w-8 h-8"></i>
                    </div>
                    <div class="text-right">
                        <h3 class="text-xl font-bold text-white group-hover:text-amber-400 transition-colors">Manual
                        </h3>
                        <p class="text-xs text-slate-500 uppercase tracking-wider mt-1">Developer Control</p>
                    </div>
                </div>

                <div class="mt-4">
                    <p class="text-slate-400 text-sm leading-relaxed" :class="{'hidden': activeMode === 'manual'}">
                        Traditional pipeline management. Use AI as an assistant via chat widgets.
                    </p>

                    <!-- Expanded Content -->
                    <div x-show="activeMode === 'manual'" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-4"
                        x-transition:enter-end="opacity-100 translate-y-0" class="mt-6 border-t border-white/10 pt-6">
                        <p class="text-slate-300 mb-6 max-w-2xl">
                            Access direct pipeline tools, SSH terminals, and log viewers. Best for debugging or custom
                            configurations.
                        </p>
                        <a href="{% url 'manual_builder' %}"
                            class="inline-flex items-center gap-2 bg-amber-600 hover:bg-amber-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-amber-900/50 transition-all hover:scale-105">
                            <i data-lucide="hammer" class="w-5 h-5"></i>
                            Open Toolkit
                        </a>
                    </div>
                </div>

                <div class="absolute bottom-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="settings" class="w-24 h-24 text-amber-500"></i>
                </div>
            </div>
        </div>

    </div>

    <!-- Project Tree Generator -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 glass rounded-xl border border-white/5 p-6">
        <div class="space-y-4">
            <div class="flex items-center gap-2">
                <i data-lucide="tree-structure" class="w-5 h-5 text-blue-400"></i>
                <h3 class="text-xl font-bold text-white">Project Tree Generator</h3>
            </div>
            <p class="text-slate-400 text-sm">Generate a suggested folder/file outline without leaving the dashboard.</p>
            <textarea x-model="treePrompt" rows="5"
                class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-slate-200 placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none text-base leading-relaxed"
                placeholder="e.g. Multitenant SaaS dashboard with billing, roles, and audit logs."></textarea>
            <div class="flex items-center gap-3">
                <button @click="generateTree()" :disabled="treeLoading"
                    class="bg-blue-600 hover:bg-blue-500 disabled:bg-blue-400 text-white px-6 py-3 rounded-xl font-semibold transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2">
                    <span x-show="!treeLoading">Generate Tree</span>
                    <span x-show="treeLoading" class="flex items-center gap-2">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Working...
                    </span>
                </button>
                <p class="text-sm text-red-400" x-text="treeError"></p>
            </div>
        </div>
        <div class="border border-white/5 rounded-2xl bg-white/5 p-4 min-h-[260px]">
            <template x-if="treeLoading">
                <div class="h-full flex items-center justify-center text-slate-300 gap-3">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                    Generating tree...
                </div>
            </template>
            <template x-if="!treeLoading && treeData">
                <div class="h-full overflow-auto">
                    <div class="mb-3">
                        <p class="text-xs uppercase text-slate-400 font-semibold">Project</p>
                        <p class="text-lg font-bold text-white" x-text="treeData.project_name"></p>
                    </div>
                    <div class="font-mono text-sm text-slate-200 space-y-1">
                        <template x-for="item in treeData.tree" :key="item.path">
                            <div class="flex items-center gap-2">
                                <i :data-lucide="item.type === 'dir' ? 'folder' : 'file'" class="w-4 h-4 text-slate-400"></i>
                                <span x-text="item.path"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
            <template x-if="!treeLoading && !treeData">
                <div class="h-full flex items-center justify-center text-slate-400 text-sm">
                    Tree will appear here after generation.
                </div>
            </template>
        </div>
    </div>

    <!-- Stats and Recent Projects -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

        <!-- Stats -->
        <div class="lg:col-span-1 space-y-6">
            <h3 class="text-lg font-bold text-white mb-4">Telemetry</h3>

            <div class="glass p-4 rounded-xl flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-xs uppercase">Total Launches</p>
                    <p class="text-2xl font-bold text-white">{{ total_launches }}</p>
                </div>
                <i data-lucide="rocket" class="text-blue-500"></i>
            </div>

            <div class="glass p-4 rounded-xl flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-xs uppercase">Success Rate</p>
                    <p class="text-2xl font-bold text-green-400">
                        {{ success_rate }}%
                    </p>
                </div>
                <i data-lucide="bar-chart-2" class="text-green-500"></i>
            </div>
        </div>

        <!-- Recent Projects -->
        <div class="lg:col-span-3">
            <div class="glass rounded-xl overflow-hidden border border-white/5">
                <div class="px-6 py-4 border-b border-white/5 flex items-center justify-between bg-white/5">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4 text-slate-400"></i>
                        Recent Orbits
                    </h3>
                    <a href="#" class="text-xs text-blue-400 hover:text-blue-300 font-medium">View All Missions</a>
                </div>
                <div class="divide-y divide-white/5">
                    {% for orbit in orbits %}
                    <div class="px-6 py-4 hover:bg-white/5 transition-colors flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center border
                                {% if orbit.status == 'completed' %}bg-green-500/10 border-green-500/20 text-green-400
                                {% elif orbit.status == 'failed' %}bg-red-500/10 border-red-500/20 text-red-400
                                {% else %}bg-blue-500/10 border-blue-500/20 text-blue-400{% endif %}">
                                <i data-lucide="{% if orbit.status == 'completed' %}check{% elif orbit.status == 'failed' %}alert-circle{% else %}loader-2{% endif %}"
                                    class="w-5 h-5 {% if orbit.status == 'processing' %}animate-spin{% endif %}"></i>
                            </div>
                            <div>
                                <div class="font-medium text-slate-200">{{ orbit.prompt|truncatechars:40 }}</div>
                                <div class="text-xs text-slate-500 flex items-center gap-2 mt-0.5">
                                    <span>{{ orbit.created_at|date:"M d, Y" }}</span>
                                    <span>â€¢</span>
                                    <span class="capitalize px-1.5 py-0.5 rounded-full text-[10px] 
                                        {% if orbit.status == 'completed' %}bg-green-500/10 text-green-400
                                        {% elif orbit.status == 'failed' %}bg-red-500/10 text-red-400
                                        {% else %}bg-blue-500/10 text-blue-400{% endif %}">
                                        {{ orbit.status }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            {% if orbit.status == 'completed' %}
                            <a href="{% url 'orbit_results' orbit.id %}"
                                class="p-2 text-slate-400 hover:text-blue-400 transition-colors" title="View Code">
                                <i data-lucide="code" class="w-4 h-4"></i>
                            </a>
                            {% elif orbit.status == 'processing' %}
                            <a href="{% url 'orbit_progress' orbit.id %}"
                                class="p-2 text-slate-400 hover:text-blue-400 transition-colors" title="View Progress">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </a>
                            {% endif %}
                            <button class="p-2 text-slate-400 hover:text-red-400 transition-colors" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="px-6 py-12 text-center text-slate-500">
                        <div
                            class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600">
                            <i data-lucide="inbox" class="w-8 h-8"></i>
                        </div>
                        <p>No missions initiated.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>


        </div>
    </div>
</div>
{% endblock %}