{% extends 'base.html' %}

{% block content %}
<div class="h-[calc(100vh-6rem)] flex overflow-hidden bg-slate-950" x-data="manualBuilder()">

    <!-- Sidebar Navigation -->
    <div class="w-64 glass-panel border-r border-slate-800 flex flex-col z-30">
        <div class="p-6">
            <h2
                class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400 mb-2">
                Orbit Builder
            </h2>
            <p class="text-xs text-slate-500">Manual Control Center</p>
        </div>

        <nav class="flex-grow space-y-1 px-3 overflow-y-auto">
            <template x-for="phase in phases" :key="phase.id">
                <button @click="activeTab = phase.id"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group relative overflow-hidden"
                    :class="activeTab === phase.id ? 'bg-blue-600/10 text-blue-400 border border-blue-500/20 shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'">

                    <div class="absolute inset-0 bg-blue-400/5 opacity-0 group-hover:opacity-100 transition-opacity"
                        x-show="activeTab !== phase.id"></div>

                    <i :data-lucide="phase.icon" class="w-5 h-5 transition-transform group-hover:scale-110"
                        :class="activeTab === phase.id ? 'text-blue-400' : 'text-slate-500'"></i>

                    <div class="text-left">
                        <div class="text-sm font-bold" x-text="phase.label"></div>
                        <div class="text-[10px] opacity-60 uppercase tracking-wider" x-text="phase.desc"></div>
                    </div>

                    <div class="absolute right-2 w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_10px_2px_rgba(59,130,246,0.5)]"
                        x-show="activeTab === phase.id"></div>
                </button>
            </template>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div
                class="bg-gradient-to-br from-indigo-500/10 to-purple-500/10 rounded-xl p-4 border border-indigo-500/20">
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 bg-indigo-500/20 rounded-lg text-indigo-400">
                        <i data-lucide="bot" class="w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-slate-200 text-sm">AI Assistant</span>
                </div>
                <p class="text-xs text-slate-400 mb-3">Need help with architecture or code?</p>
                <button @click="showChat = true"
                    class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-xs font-bold transition-colors shadow-lg shadow-indigo-900/40">
                    Open Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-grow relative bg-slate-900">

        <!-- Top Bar -->
        <div
            class="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur z-20 absolute top-0 w-full">
            <div class="flex items-center gap-4">
                <h3 class="text-lg font-bold text-slate-200" x-text="phases.find(p => p.id === activeTab)?.label"></h3>
                <span
                    class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-800 text-slate-500 border border-slate-700">MANUAL
                    MODE</span>
            </div>

            <div class="flex gap-2" x-show="activeTab !== 'Deployment'">
                <span x-show="saving" class="text-xs text-slate-500 animate-pulse mr-2 flex items-center">
                    <i data-lucide="loader-2" class="w-3 h-3 mr-1 animate-spin"></i> Saving...
                </span>
                <button @click="saveNote()"
                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium text-sm transition-all shadow-lg shadow-blue-900/20">
                    <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                </button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="pt-16 h-full">

            <!-- Standard SDLC Tabs (Editor) -->
            <div x-show="activeTab !== 'Deployment'" class="h-full p-8 overflow-y-auto">
                <div class="max-w-5xl mx-auto h-full flex flex-col">
                    <div
                        class="bg-slate-950 border border-slate-800 rounded-2xl shadow-xl flex-grow flex flex-col overflow-hidden">
                        <!-- Editor Toolbar -->
                        <div class="px-4 py-2 bg-slate-900 border-b border-slate-800 flex items-center gap-2">
                            <div class="flex gap-1">
                                <div class="w-3 h-3 rounded-full bg-slate-700"></div>
                                <div class="w-3 h-3 rounded-full bg-slate-700"></div>
                            </div>
                            <span class="text-xs text-slate-500 font-mono ml-2"
                                x-text="activeTab.toLowerCase() + '.md'"></span>
                        </div>

                        <!-- Text Area -->
                        <textarea x-model="notes[activeTab]" @input="autoSave()"
                            class="flex-grow w-full bg-slate-950 p-6 text-slate-300 font-mono text-sm resize-none focus:outline-none leading-relaxed"
                            placeholder="# Write your documentation, requirements, or code snippets here..."></textarea>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-xs text-slate-600">
                            Tip: Use this space to document the <span x-text="activeTab"></span> phase of your project.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Deployment Tab (Pipeline Builder) -->
            <div x-show="activeTab === 'Deployment'" class="h-full w-full relative" x-data="pipelineBuilder()">
                <!-- RE-INSERTING PIPELINE BUILDER HTML STRUCTURE HERE -->

                <!-- Pipeline Toolbar (Embedded) -->
                <div
                    class="absolute top-0 left-0 right-0 h-16 pointer-events-none flex items-center justify-end px-8 z-30">
                    <div class="pointer-events-auto flex gap-2">
                        <button @click="savePipeline()"
                            class="p-2 text-slate-400 hover:text-white bg-slate-800 border border-slate-700 rounded-lg transition-colors">
                            <i data-lucide="save" class="w-5 h-5"></i>
                        </button>
                        <button
                            class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-medium shadow-lg shadow-green-900/20 transition-all flex items-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i> Run Pipeline
                        </button>
                    </div>
                </div>

                <div class="flex h-full">
                    <!-- Toolbox -->
                    <div class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col z-10 pt-4">
                        <div
                            class="p-4 font-semibold text-slate-400 text-xs uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="box" class="w-4 h-4"></i> Pipeline Tools
                        </div>
                        <div class="p-4 space-y-3 overflow-y-auto flex-grow">
                            <template x-for="tool in tools" :key="tool.type">
                                <div draggable="true" @dragstart="dragStart($event, tool)"
                                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl cursor-move transition-all flex items-center gap-3 group select-none shadow-sm">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center shadow-inner bg-slate-900"
                                        :class="tool.text">
                                        <i :data-lucide="tool.icon" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-slate-200" x-text="tool.label"></div>
                                        <div class="text-[10px] text-slate-500" x-text="tool.desc"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Canvas -->
                    <div class="flex-grow bg-slate-950 relative overflow-hidden select-none" @dragover.prevent
                        @drop="drop($event)" @mousedown="canvasMouseDown($event)" @mousemove="canvasMouseMove($event)"
                        @mouseup="canvasMouseUp($event)"
                        style="background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 24px 24px;">

                        <!-- Connections Layer -->
                        <svg class="absolute inset-0 w-full h-full pointer-events-none z-0">
                            <template x-for="conn in connections" :key="conn.id">
                                <path :d="getPath(conn)" stroke="#475569" stroke-width="2" fill="none"
                                    marker-end="url(#arrowhead)" />
                            </template>
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5"
                                    orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#475569" />
                                </marker>
                            </defs>
                        </svg>

                        <!-- Blocks -->
                        <template x-for="block in pipeline.blocks" :key="block.id">
                            <div class="absolute w-56 bg-slate-900 border rounded-xl shadow-xl flex flex-col z-10 group transition-all"
                                :class="selectedBlock === block ? 'border-blue-500 shadow-blue-500/20' : 'border-slate-700 hover:border-slate-500'"
                                :style="`left: ${block.x}px; top: ${block.y}px; cursor: grab;`"
                                @mousedown.stop="blockMouseDown($event, block)">
                                <!-- Header -->
                                <div
                                    class="px-4 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-800/50 rounded-t-xl">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2.5 h-2.5 rounded-full" :class="getBlockColor(block.type)"></div>
                                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                                            x-text="block.type"></span>
                                    </div>
                                    <button @click.stop="removeBlock(block.id)"
                                        class="text-slate-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </div>
                                <!-- Body -->
                                <div class="p-4">
                                    <div class="font-bold text-slate-200 text-sm truncate mb-1" x-text="block.name">
                                    </div>
                                    <div class="text-xs text-slate-500 truncate flex items-center gap-1">
                                        <i data-lucide="cpu" class="w-3 h-3"></i>
                                        <span
                                            x-text="block.tools.length > 0 ? block.tools.join(', ') : 'No tools'"></span>
                                    </div>
                                </div>
                                <!-- Ports -->
                                <div class="absolute -left-2.5 top-1/2 w-5 h-5 bg-slate-800 rounded-full border-2 border-slate-600 cursor-crosshair hover:border-blue-500 transition-colors shadow-sm flex items-center justify-center z-20"
                                    @mousedown.stop="startConnection(block, 'in')">
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                                </div>
                                <div class="absolute -right-2.5 top-1/2 w-5 h-5 bg-slate-800 rounded-full border-2 border-slate-600 cursor-crosshair hover:border-blue-500 transition-colors shadow-sm flex items-center justify-center z-20"
                                    @mousedown.stop="startConnection(block, 'out')">
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                                </div>
                            </div>
                        </template>

                        <!-- Dragging Line -->
                        <svg x-show="isConnecting" class="absolute inset-0 w-full h-full pointer-events-none z-20">
                            <line :x1="dragLine.x1" :y1="dragLine.y1" :x2="dragLine.x2" :y2="dragLine.y2"
                                stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,5" />
                        </svg>
                    </div>

                    <!-- Inspector -->
                    <div class="w-80 bg-slate-900 border-l border-slate-800 flex flex-col shadow-xl z-20 absolute right-0 h-full"
                        x-show="selectedBlock" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0">
                        <div class="p-4 border-b border-slate-800 font-semibold text-slate-200 flex items-center gap-2">
                            <i data-lucide="settings-2" class="w-4 h-4 text-slate-400"></i> Inspector
                        </div>
                        <div class="p-6 space-y-6 overflow-y-auto flex-grow">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Block Name</label>
                                <input type="text" x-model="selectedBlock.name"
                                    class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tools</label>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="tool in ['Git', 'Docker', 'Jest', 'AWS', 'NPM']">
                                        <button @click="toggleTool(tool)"
                                            class="px-3 py-1.5 rounded-lg text-xs font-medium border transition-all"
                                            :class="selectedBlock.tools.includes(tool) ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500'"
                                            x-text="tool"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div x-cloak x-show="showChat" x-data="chatWidget()"
        class="fixed bottom-6 right-6 w-96 h-[500px] bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col overflow-hidden z-50 transform transition-all"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-10 scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 scale-100" @click.away="showChat = false">

        <!-- Header -->
        <div class="p-4 bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-between">
            <div class="flex items-center gap-2 text-white">
                <i data-lucide="bot" class="w-5 h-5"></i>
                <span class="font-bold">Orbit AI Guide</span>
            </div>
            <button @click="showChat = false" class="text-white/80 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Messages -->
        <div class="flex-grow p-4 overflow-y-auto space-y-4 bg-slate-950/50" id="chat-messages">
            <template x-for="msg in messages" :key="msg.id">
                <div class="flex gap-3" :class="msg.sender === 'user' ? 'flex-row-reverse' : ''">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"
                        :class="msg.sender === 'user' ? 'bg-blue-600' : 'bg-purple-600'">
                        <i :data-lucide="msg.sender === 'user' ? 'user' : 'bot'" class="w-4 h-4 text-white"></i>
                    </div>
                    <div class="max-w-[80%] p-3 rounded-xl text-sm leading-relaxed"
                        :class="msg.sender === 'user' ? 'bg-blue-600/10 text-blue-100 border border-blue-600/20' : 'bg-slate-800 text-slate-200 border border-slate-700'">
                        <span x-text="msg.text"></span>
                    </div>
                </div>
            </template>
            <div x-show="loading" class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center">
                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="p-3 rounded-xl bg-slate-800 border border-slate-700">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-100"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-200"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="p-4 bg-slate-900 border-t border-slate-800">
            <form @submit.prevent="sendMessage" class="relative">
                <input type="text" x-model="userInput" placeholder="Ask guidance..."
                    class="w-full bg-slate-950 border border-slate-700 rounded-xl pl-4 pr-12 py-3 text-sm text-white focus:ring-2 focus:ring-purple-500 outline-none">
                <button type="submit"
                    class="absolute right-2 top-2 p-1.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function manualBuilder() {
        return {
            activeTab: 'Requirement',
            showChat: false,
            saving: false,
            notes: {
                'Requirement': '',
                'Analysis': '',
                'Design': '',
                'Implementation': '',
                'Testing': ''
            },
            noteIds: {},
            phases: [
                { id: 'Requirement', label: 'Requirements', desc: 'Define goals & scope', icon: 'list-todo' },
                { id: 'Analysis', label: 'Analysis', desc: 'Feasibility & planning', icon: 'search' },
                { id: 'Design', label: 'Design', desc: 'System architecture', icon: 'layout' },
                { id: 'Implementation', label: 'Implementation', desc: 'Code & build', icon: 'code-2' },
                { id: 'Testing', label: 'Testing', desc: 'QA & Verification', icon: 'beaker' },
                { id: 'Deployment', label: 'Deployment', desc: 'CI/CD Pipeline', icon: 'rocket' }
            ],

            async init() {
                await this.fetchAllNotes();
                // Ensure lucide icons in sidebar load
                setTimeout(() => lucide.createIcons(), 50);
            },

            async fetchAllNotes() {
                try {
                    const response = await fetch('/api/sdlc/notes/');
                    if (response.ok) {
                        const data = await response.json();
                        data.forEach(note => {
                            if (this.notes.hasOwnProperty(note.phase)) {
                                this.notes[note.phase] = note.content;
                                this.noteIds[note.phase] = note.id;
                            }
                        });
                    }
                } catch (e) {
                    console.error("Failed to fetch notes", e);
                }
            },

            autoSaveTimer: null,
            autoSave() {
                if (this.autoSaveTimer) clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = setTimeout(() => this.saveNote(true), 2000);
            },

            async saveNote(silent = false) {
                if (!silent) this.saving = true;
                const phase = this.activeTab;
                if (phase === 'Deployment') return; // Pipeline saves separately

                const content = this.notes[phase];
                const noteId = this.noteIds[phase];

                try {
                    let url = '/api/sdlc/notes/';
                    let method = 'POST';

                    if (noteId) {
                        url += `${noteId}/`;
                        method = 'PUT';
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            phase: phase,
                            content: content
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.noteIds[phase] = data.id; // Store ID for future updates
                    }
                } catch (e) {
                    console.error("Save failed", e);
                } finally {
                    if (!silent) {
                        setTimeout(() => this.saving = false, 500);
                    }
                }
            }
        }
    }

    function chatWidget() {
        return {
            userInput: '',
            messages: [
                { id: 1, sender: 'bot', text: 'Hello! I am your AI assistant. How can I help you with your project today?' }
            ],
            loading: false,

            async sendMessage() {
                if (!this.userInput.trim()) return;

                const text = this.userInput;
                this.userInput = '';
                this.messages.push({ id: Date.now(), sender: 'user', text: text });

                this.loading = true;
                this.scrollToBottom();

                try {
                    // Call API
                    const response = await fetch('/api/ai/chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ message: text }) // Context could be added here
                    });

                    const data = await response.json();

                    this.messages.push({
                        id: Date.now() + 1,
                        sender: 'bot',
                        text: data.reply || "I'm having trouble connecting right now."
                    });
                    setTimeout(() => lucide.createIcons(), 50);
                } catch (e) {
                    this.messages.push({
                        id: Date.now() + 1,
                        sender: 'bot',
                        text: "Error: Could not reach the AI agent."
                    });
                    setTimeout(() => lucide.createIcons(), 50);
                } finally {
                    this.loading = false;
                    this.scrollToBottom();
                }
            },

            scrollToBottom() {
                this.$nextTick(() => {
                    const el = document.getElementById('chat-messages');
                    if (el) el.scrollTop = el.scrollHeight;
                });
            }
        }
    }

    // Existing Pipeline Builder Logic (Adapted for Dark Mode & Integration)
    function pipelineBuilder() {
        return {
            pipeline: {
                name: 'New Pipeline',
                blocks: []
            },
            connections: [],
            tools: [
                { type: 'source', label: 'Source', desc: 'Git, GitHub', text: 'text-orange-400', icon: 'git-branch' },
                { type: 'build', label: 'Build', desc: 'NPM, Gradle', text: 'text-blue-400', icon: 'package' },
                { type: 'test', label: 'Test', desc: 'Jest, Selenium', text: 'text-green-400', icon: 'beaker' },
                { type: 'deploy', label: 'Deploy', desc: 'Docker, Vercel', text: 'text-purple-400', icon: 'rocket' },
                { type: 'monitor', label: 'Monitor', desc: 'Sentry', text: 'text-red-400', icon: 'activity' },
            ],
            selectedBlock: null,
            isDragging: false,
            dragOffset: { x: 0, y: 0 },
            isConnecting: false,
            connectionStart: null,
            dragLine: { x1: 0, y1: 0, x2: 0, y2: 0 },

            init() {
                setTimeout(() => lucide.createIcons(), 100);
            },

            dragStart(event, tool) {
                event.dataTransfer.setData('toolType', tool.type);
                event.dataTransfer.setData('toolLabel', tool.label);
            },

            drop(event) {
                const type = event.dataTransfer.getData('toolType');
                const label = event.dataTransfer.getData('toolLabel');
                if (type) {
                    const rect = event.target.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;

                    this.pipeline.blocks.push({
                        id: Date.now(),
                        type: type,
                        name: label,
                        x: x - 112,
                        y: y - 40,
                        tools: []
                    });
                    setTimeout(() => lucide.createIcons(), 50);
                }
            },

            blockMouseDown(event, block) {
                this.selectedBlock = block;
                this.isDragging = true;
                this.dragOffset = {
                    x: event.clientX - block.x,
                    y: event.clientY - block.y
                };
            },

            canvasMouseMove(event) {
                if (this.isDragging && this.selectedBlock) {
                    this.selectedBlock.x = event.clientX - this.dragOffset.x;
                    this.selectedBlock.y = event.clientY - this.dragOffset.y;
                }
                if (this.isConnecting) {
                    const rect = event.currentTarget.getBoundingClientRect();
                    this.dragLine.x2 = event.clientX - rect.left;
                    this.dragLine.y2 = event.clientY - rect.top;
                }
            },

            canvasMouseUp() {
                this.isDragging = false;
                this.isConnecting = false;
            },

            removeBlock(id) {
                this.pipeline.blocks = this.pipeline.blocks.filter(b => b.id !== id);
                this.connections = this.connections.filter(c => c.from !== id && c.to !== id);
                if (this.selectedBlock && this.selectedBlock.id === id) {
                    this.selectedBlock = null;
                }
            },

            getBlockColor(type) {
                const colors = {
                    'source': 'bg-orange-500',
                    'build': 'bg-blue-500',
                    'test': 'bg-green-500',
                    'deploy': 'bg-purple-500',
                    'monitor': 'bg-red-500'
                };
                return colors[type] || 'bg-slate-500';
            },

            startConnection(block, portType) {
                this.isConnecting = true;
                this.connectionStart = { block, portType };
                const x = portType === 'out' ? block.x + 224 : block.x;
                const y = block.y + 60;
                this.dragLine = { x1: x, y1: y, x2: x, y2: y };
            },

            getPath(conn) {
                const fromBlock = this.pipeline.blocks.find(b => b.id === conn.from);
                const toBlock = this.pipeline.blocks.find(b => b.id === conn.to);
                if (!fromBlock || !toBlock) return '';
                const x1 = fromBlock.x + 224, y1 = fromBlock.y + 60;
                const x2 = toBlock.x, y2 = toBlock.y + 60;
                const cp1x = x1 + (x2 - x1) / 2, cp2x = x2 - (x2 - x1) / 2;
                return `M ${x1} ${y1} C ${cp1x} ${y1}, ${cp2x} ${y2}, ${x2} ${y2}`;
            },

            toggleTool(tool) {
                if (!this.selectedBlock) return;
                if (this.selectedBlock.tools.includes(tool)) {
                    this.selectedBlock.tools = this.selectedBlock.tools.filter(t => t !== tool);
                } else {
                    this.selectedBlock.tools.push(tool);
                }
            },

            async savePipeline() {
                // Implementation for saving (Can optionally use the manualBuilder's save toast)
                // For now, simple alert
                alert('Pipeline configuration saved!');
            }
        }
    }
</script>
{% endblock %}