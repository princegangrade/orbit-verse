{% extends 'base.html' %}

{% block content %}
{% if orbit.artifacts.files %}
{{ orbit.artifacts.files|json_script:"files-data" }}
{% else %}
{{ "[]"|json_script:"files-data" }}
{% endif %}

<div class="h-[calc(100vh-6rem)] flex flex-col" x-data="ide()">
    <!-- IDE Header -->
    <div class="h-14 glass border-b border-slate-700/50 flex items-center justify-between px-4 shadow-sm z-20">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <a href="/" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                </a>
                <div
                    class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center text-blue-400 border border-blue-500/20">
                    <i data-lucide="box" class="w-4 h-4"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-100 text-sm leading-tight">Project Results</h1>
                    <p class="text-xs text-slate-400">{{ orbit.prompt|truncatechars:40 }}</p>
                </div>
            </div>
            <div class="h-6 w-px bg-slate-700"></div>
            <div class="flex bg-slate-900/50 p-1 rounded-lg border border-slate-700/50">
                <button @click="activeTab = 'code'" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all"
                    :class="activeTab === 'code' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'">
                    <i data-lucide="code-2" class="w-3 h-3 inline mr-1"></i> Code
                </button>
                <button @click="activeTab = 'preview'; updatePreview()"
                    class="px-3 py-1.5 rounded-md text-xs font-medium transition-all"
                    :class="activeTab === 'preview' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'">
                    <i data-lucide="play" class="w-3 h-3 inline mr-1"></i> Preview
                </button>
            </div>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'orbit_download' orbit.id %}"
                class="px-3 py-1.5 glass hover:bg-slate-800 text-slate-300 rounded-lg text-xs font-medium transition-all shadow-sm flex items-center gap-2 border border-slate-600">
                <i data-lucide="download" class="w-3 h-3"></i> Download
            </a>
            <a href="{% url 'github_push' orbit.id %}"
                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-xs font-medium transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2">
                <i data-lucide="github" class="w-3 h-3"></i> Push
            </a>
        </div>
    </div>

    <!-- IDE Body -->
    <div class="flex-grow flex overflow-hidden">
        <!-- File Explorer -->
        <div class="w-64 glass-panel border-r border-slate-700/50 flex flex-col">
            <div
                class="p-3 border-b border-slate-700/50 text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-900/30">
                Explorer</div>
            <div class="overflow-y-auto p-2 space-y-0.5">
                <template x-for="file in files" :key="file.path">
                    <button @click="selectFile(file)"
                        class="w-full text-left px-3 py-2 rounded-lg text-xs transition-all truncate flex items-center gap-2"
                        :class="selectedFile === file ? 'bg-blue-500/20 text-blue-400 font-medium border border-blue-500/20' : 'text-slate-400 hover:bg-slate-800/50'">
                        <i :data-lucide="getFileIcon(file.path)" class="w-3 h-3"></i>
                        <span x-text="file.path"></span>
                    </button>
                </template>
            </div>
        </div>

        <!-- Main Area -->
        <div class="flex-grow flex flex-col bg-slate-900 relative">
            <!-- Code Editor -->
            <div x-show="activeTab === 'code'" class="absolute inset-0 flex flex-col">
                <div class="h-9 border-b border-slate-700/50 flex items-center px-4 bg-slate-900">
                    <span class="text-xs text-slate-400"
                        x-text="selectedFile ? selectedFile.path : 'No file selected'"></span>
                </div>
                <div class="flex-grow overflow-auto">
                    <pre
                        class="p-4 text-sm font-mono text-slate-300 leading-relaxed"><code x-text="selectedFile ? selectedFile.content : ''"></code></pre>
                </div>
            </div>

            <!-- Preview Window -->
            <div x-show="activeTab === 'preview'" :class="fullScreenPreview ? 'fixed inset-0 z-50' : 'absolute inset-0'"
                class="flex flex-col bg-slate-950 transition-all duration-200"
                @keydown.escape.window="fullScreenPreview = false; $nextTick(() => lucide.createIcons())">
                <div
                    class="h-9 border-b border-slate-700/50 flex items-center px-4 bg-slate-900 justify-between shrink-0">
                    <div
                        class="flex items-center gap-2 text-xs text-slate-400 bg-slate-800 px-2 py-1 rounded-full border border-slate-700 w-full max-w-md">
                        <i data-lucide="lock" class="w-3 h-3"></i> <span>localhost:3000</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="fullScreenPreview = !fullScreenPreview; $nextTick(() => lucide.createIcons())"
                            class="text-slate-400 hover:text-white transition-colors" title="Toggle Full Screen">
                            <i :data-lucide="fullScreenPreview ? 'minimize-2' : 'maximize-2'" class="w-3 h-3"></i>
                        </button>
                        <div class="w-px h-3 bg-slate-700"></div>
                        <button @click="updatePreview()" class="text-slate-400 hover:text-white transition-colors"><i
                                data-lucide="refresh-cw" class="w-3 h-3"></i></button>
                    </div>
                </div>
                <div class="flex-grow p-4">
                    <div
                        class="w-full h-full bg-white rounded-lg shadow-sm border border-slate-700 overflow-hidden relative">
                        <iframe id="preview-frame" class="w-full h-full border-0"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Console -->
    <div class="h-48 bg-slate-950 border-t border-slate-700 flex flex-col" x-data="{ open: true }"
        :class="open ? 'h-48' : 'h-9'">
        <div class="h-9 bg-slate-900 flex items-center justify-between px-4 cursor-pointer hover:bg-slate-800 border-b border-slate-700"
            @click="open = !open">
            <div class="flex items-center gap-2 text-xs font-medium text-slate-400"><i data-lucide="terminal"
                    class="w-3 h-3"></i> Console</div>
            <i :data-lucide="open ? 'chevron-down' : 'chevron-up'" class="w-3 h-3 text-slate-500"></i>
        </div>
        <div class="flex-grow overflow-auto p-3 font-mono text-xs space-y-1 bg-black/50" x-show="open">
            <div class="text-green-500">> Build process initialized...</div>
            <template x-for="file in files" :key="file.path">
                <div class="text-slate-500"> + Writing <span x-text="file.path"></span></div>
            </template>
            <div class="text-blue-400">> Ready on http://localhost:3000</div>
        </div>
    </div>
</div>

<script>
    window.ide = function () {
        return {
            files: [],
            selectedFile: null,
            activeTab: 'code',
            fullScreenPreview: false,

            init() {
                try {
                    const dataEl = document.getElementById('files-data');
                    if (dataEl) this.files = JSON.parse(dataEl.textContent || '[]');
                } catch (e) { this.files = []; }
                if (this.files.length > 0) this.selectedFile = this.files.find(f => f.path === 'src/App.tsx') || this.files[0];
                setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 50);
            },
            selectFile(file) { this.selectedFile = file; this.activeTab = 'code'; },
            getFileIcon(path) {
                if (path.endsWith('.css')) return 'palette';
                if (path.endsWith('.js')) return 'file-code';
                return 'file';
            },
            updatePreview() {
                const frame = document.getElementById('preview-frame');
                if (!frame) return;

                // Find Vanilla Files
                const indexHtml = this.files.find(f => f.path.endsWith('index.html'));
                const cssFile = this.files.find(f => f.path.endsWith('.css'));
                const jsFile = this.files.find(f => f.path.endsWith('.js'));

                if (indexHtml) {
                    let content = indexHtml.content;

                    // Inject Tailwind if not present
                    if (!content.includes('tailwindcss')) {
                        content = content.replace('</head>', '<script src="https://cdn.tailwindcss.com"><\/script></head>');
                    }

                    // Inject Custom CSS
                    if (cssFile) {
                        content = content.replace('</head>', `<style>${cssFile.content}</style></head>`);
                    }

                    // ----------------------------------------------------
                    // CONSOLE CAPTURE SCRIPT
                    // ----------------------------------------------------
                    const consoleScript = `
                        <script>
                            (function() {
                                const oldLog = console.log;
                                const oldInfo = console.info;
                                const oldWarn = console.warn;
                                const oldError = console.error;
                                
                                function sendLog(type, args) {
                                    try {
                                        const message = Array.from(args).map(arg => {
                                            if (typeof arg === 'object') return JSON.stringify(arg);
                                            return String(arg);
                                        }).join(' ');
                                        window.parent.postMessage({ type: 'console', level: type, message: message }, '*');
                                    } catch (e) {}
                                }
        
                                console.log = function(...args) { oldLog.apply(console, args); sendLog('log', args); };
                                console.info = function(...args) { oldInfo.apply(console, args); sendLog('info', args); };
                                console.warn = function(...args) { oldWarn.apply(console, args); sendLog('warn', args); };
                                console.error = function(...args) { oldError.apply(console, args); sendLog('error', args); };
                                
                                window.addEventListener('error', function(e) {
                                    sendLog('error', [e.message]);
                                });
                            })();
                        <\/script>
                    `;
                    content = content.replace('<head>', '<head>' + consoleScript);

                    // Inject JS
                    if (jsFile) {
                        content = content.replace('</body>', `<script>${jsFile.content}<\/script></body>`);
                        // Also remove external script ref to prevent double loading/404
                        content = content.replace(/<script src=".*?script\.js.*?"><\/script>/g, '');
                    }

                    frame.srcdoc = content;

                    // Listen for messages from iframe
                    window.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'console') {
                            const consoleDiv = document.querySelector('.h-48 .overflow-auto');
                            if (consoleDiv) {
                                const logEl = document.createElement('div');
                                logEl.className = 'font-mono text-xs mb-1 flex gap-2';

                                let color = 'text-slate-300';
                                if (event.data.level === 'warn') color = 'text-yellow-400';
                                if (event.data.level === 'error') color = 'text-red-400';

                                const time = new Date().toLocaleTimeString();
                                logEl.innerHTML = `<span class="text-slate-600">[${time}]</span> <span class="${color}">${event.data.message}</span>`;
                                consoleDiv.appendChild(logEl);
                                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                            }
                        }
                    });

                } else {
                    frame.srcdoc = '<div style="padding:20px;color:#64748b;">No index.html found.</div>';
                }
            }
        }
    }
</script>
{% endblock %}